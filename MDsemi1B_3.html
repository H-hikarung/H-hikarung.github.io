<html lang="ja">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<title>ãŠã˜ã•ã‚“ãŒã„ã‚ã„ã‚ç­”ãˆã‚‹éŸ³å£°å¯¾è©±ã‚·ã‚¹ãƒ†ãƒ  by Javascript</title>
<style>
body {
    margin: 0;
    padding-top: 100px;
    text-align: center;
}

.header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: #f1f1f1;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    z-index: 1000;
}

h1 {
    margin: 0;
    font-size: 24px;
}

.header p {
    margin: 15px 0;
}

.header button {
    margin: 5px;
    padding: 10px 20px;
    font-size: 16px;
}

.header input {
    padding: 10px;
    font-size: 16px;
    width: 80%;
    max-width: 300px;
    margin-top: 10px;
}

#resultOutput {
    margin: 20px;
    font-size: 18px;
    text-align: left;
}
</style>

</head>
<body>

<h1>ãŠã˜ã•ã‚“ãŒã„ã‚ã„ã‚ç­”ãˆã‚‹éŸ³å£°å¯¾è©±ã‚·ã‚¹ãƒ†ãƒ </h1>

<p>
<label for="username">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:</label>
<input type="text" id="username" name="username">
</p>

<p>
<button id="startButton">start</button>
<button id="stopButton">stop</button>
</p>

<p>
<div id="resultOutput"></div>
</p>

<script>
// å¿œç­”ã®å®šç¾©ï¼ˆãƒãƒƒã‚·ãƒ¥ï¼‰
var response = {
    "ã‚ãªãŸ,èª°": "ãŠã˜ã•ã‚“ã¯ãŠã˜ã•ã‚“ãƒ€ãƒ¨ã€œâ—ğŸ˜†ğŸ‘ ã§ã‚‚ãã‚“ãªãŠã˜ã•ã‚“ã‚‚æ‚ªããªã„ãƒ‡ã‚·ãƒ§â“ãƒŠãƒ³ãƒãƒ£ãƒƒãƒ†ã€œğŸ˜‚ğŸ’¦ ãŠã˜ã•ã‚“ã¯ã„ã¤ã§ã‚‚{username}ã¡ã‚ƒã‚“ã®å¿œæ´å›£ã ãƒ¨ï½ğŸ“£â¤ï¸",
    "ä½•æ­³": "ãŠã˜ã•ã‚“ã€ä½•æ­³ã«è¦‹ãˆã‚‹ã‚«ãƒŠã€œâ“ğŸ˜† è‹¥ãè¦‹ã‚‰ã‚ŒãŸã‚‰å¬‰ã—ã„ãƒŠã€œğŸ˜ğŸ’¦ ã¾ãã€å¹´é½¢ã¯æ°—æŒã¡ã®å•é¡Œãƒ€ãƒ¨ã€œâ¤ï¸âœ¨ ãƒŠãƒ³ãƒãƒ£ãƒƒãƒ†ğŸ¤£âœ¨",
    "å…ƒæ°—": "ãŠã˜ã•ã‚“ã¯å…ƒæ°—ãƒ€ãƒ¨ã€œğŸ’ªğŸ˜†âœ¨ ã„ã¤ã§ã‚‚ãƒ•ãƒ«ãƒ‘ãƒ¯ãƒ¼ã§é ‘å¼µã£ã¦ã‚‹ã‚“ã ã‚¼ã€œâ—ï¸ğŸ˜ğŸ‘ {username}ã¡ã‚ƒã‚“ã‚‚å…ƒæ°—ã§éã”ã—ã¦ãƒã€œâ¤ï¸âœ¨",
    "ãŠã¯ã‚ˆã†": "ãŠã¯ã‚ˆã†ã€{username}ã¡ã‚ƒã‚“â—â— æ˜¨æ—¥ã¯ã¡ã‚ƒã‚“ã¨å¯ã‚ŒãŸã‹ãªâ“ ãŠã˜ã•ã‚“ã¯æœã‹ã‚‰ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’æ·¹ã‚Œã¦â˜•ã»ã£ã¨ä¸€æ¯ã¤ã„ã¦ã‚‹ã‚ˆğŸ˜ğŸ’• ãã†ã„ãˆã°ã“ã®å‰ç´ æ•µãªã‚«ãƒ•ã‚§ã‚’è¦‹ã¤ã‘ãŸã‚ˆğŸ°â˜• ğŸªä»Šåº¦{username}ã¡ã‚ƒã‚“ã¨è¡ŒããŸã„ãªğŸ˜ğŸ’– ä»Šæ—¥ã‚‚é ‘å¼µã£ã¦ã­ğŸ’ªğŸ˜Š ãŠã˜ã•ã‚“ã¯ã„ã¤ã‚‚{username}ã¡ã‚ƒã‚“ã®å‘³æ–¹ã ã‚ˆğŸ˜‹ğŸ§¡ ãã‚Œã˜ã‚ƒã€ã„ã„ä¸€æ—¥ã‚’âœ‹ğŸŒˆ",
    "ã“ã‚“ã«ã¡ã¯": "ã“ã‚“ã«ã¡ã¯ğŸ‘‹ğŸ˜„ {username}ã¡ã‚ƒã‚“ã€ãŠã˜ã•ã‚“ã ã‚ˆã€œâœ¨ å…ƒæ°—ã‚«ãƒŠâ“ğŸ’– ä½•ã‹æ¥½ã—ã„ã“ã¨ã‚ã£ãŸã‚«ãƒŠâ“ ãŠã˜ã•ã‚“ã€æœ€è¿‘æ–°ã—ã„ã‚¹ãƒãƒ›è²·ã£ã¡ã‚ƒã£ã¦ã­ğŸ“±ğŸ˜ ã‚‚ã†ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¡ã‚ƒã£ã¦ã‚‹ãƒ¨â—âœ¨ ã¾ãŸãŠè©±ã—ã‚ˆã†ãƒã€œâ¤ï¸ğŸ’¬âœ¨",
    "ã“ã‚“ã°ã‚“ã¯": "ã“ã‚“ã°ã‚“ã¯ã€{username}ã¡ã‚ƒã‚“ğŸŒ™âœ¨ ä»Šæ—¥ã‚‚ä¸€æ—¥ãŠç–²ã‚Œã‚µãƒã€œğŸ˜ŠğŸ’• ã‚†ã£ãã‚Šä¼‘ã‚“ã§ãƒã€œâ—",
    "å¥½ããª,é£Ÿã¹ç‰©": "ãŠã˜ã•ã‚“ã­ã€œã€ãŠé…’ğŸ¶ã¨ã™ã‚‹ã‚ğŸ¦‘ãŒå¤§å¥½ããªã‚“ã ãƒ¨ã€œâ—ğŸ˜Šâœ¨ ã„ã‚„ãã€ã“ã‚ŒãŒã‚ã‚Œã°ç„¡æ•µã‚«ãƒ¢â“",
    "å¤¢ã¯": "{username}ã¡ã‚ƒã‚“ã¨ä¸€ç·’ã«ä¸–ç•Œä¸€å‘¨ã™ã‚‹ã“ã¨ã‚«ãƒŠã€œğŸŒâœˆï¸â¤ï¸ ãã‚ŒãŒå¤¢ãªã‚“ã ãƒ¨ã€œâœ¨ãŠã˜ã•ã‚“ã€å¦„æƒ³ã—ã¡ã‚ƒã£ã¦ã‚‹ã‚«ãƒ¢â“ãƒŠãƒ³ãƒãƒ£ãƒƒãƒ†ğŸ˜ğŸ’•"
};

var appid = 'dj00aiZpPVRKRTNjT2hGZ24wUCZzPWNvbnN1bWVyc2VjcmV0Jng9ODE-';

const startButton = document.querySelector('#startButton'); // é–‹å§‹ãƒœã‚¿ãƒ³
const stopButton = document.querySelector('#stopButton'); // åœæ­¢ãƒœã‚¿ãƒ³
const resultOutput = document.querySelector('#resultOutput'); // çµæœå‡ºåŠ›ã‚¨ãƒªã‚¢

if (!'SpeechSynthesisUtterance' in window) {
    alert("ã‚¢ãƒ©ãƒ©ï½ğŸ’¦ğŸ’»{username}ã¡ã‚ƒã‚“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã­ã€Speech Synthesis APIã«ã¯æœªå¯¾å¿œã¿ãŸã„ãªã‚“ã ï½ğŸ˜…ğŸ’” ã”ã‚ã‚“ãƒï½ã€ãŠã˜ã•ã‚“ã‚‚ã¡ã‚‡ã£ã¨ã³ã£ãã‚Šã—ã¡ã‚ƒã£ãŸã‚ˆâ—ğŸ˜²ğŸ’¦ {username}ã¡ã‚ƒã‚“ã¨ãŠè©±ã—ğŸ—£ï¸ã™ã‚‹ã®æ¥½ã—ã¿ã«ã—ã¦ã‚‹ãƒ¨ï½â—ğŸ˜ğŸ’– å¾…ã£ã¦ã‚‹ã‹ã‚‰ãƒğŸ˜‰ğŸ‘âœ¨");
}
const tts = new SpeechSynthesisUtterance(); // TTSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
tts.lang = "ja-JP"; // è¨€èª(æ—¥æœ¬èª)ã€è‹±èªã®å ´åˆã¯en-US
tts.rate = 1.0; // é€Ÿåº¦
tts.pitch = 1.0; // å£°ã®é«˜ã•
tts.volume = 1.0; // éŸ³é‡

//éŸ³å£°ãƒªã‚¹ãƒˆãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆ, å£°ã‚’ç”·æ€§(Microsoft Ichiro)ã«å¤‰æ›´
speechSynthesis.onvoiceschanged = function() {
    var voice = speechSynthesis.getVoices().find(function(voice){
        return voice.name === 'Microsoft Ichiro - Japanese (Japan)';
    });
    if (voice) {
        tts.voice = voice;
    }
};

SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
if (!'SpeechRecognition' in window) {
    alert("ã‚¢ãƒ©ãƒ©ï½ğŸ’¦ğŸ’»{username}ã¡ã‚ƒã‚“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã­ã€Speech Recognition APIã«ã¯æœªå¯¾å¿œã¿ãŸã„ãªã‚“ã ï½ğŸ˜…ğŸ’” ã”ã‚ã‚“ãƒï½ã€ãŠã˜ã•ã‚“ã‚‚ã¡ã‚‡ã£ã¨ã³ã£ãã‚Šã—ã¡ã‚ƒã£ãŸã‚ˆâ—ğŸ˜²ğŸ’¦ {username}ã¡ã‚ƒã‚“ã¨ãŠè©±ã—ğŸ—£ï¸ã™ã‚‹ã®æ¥½ã—ã¿ã«ã—ã¦ã‚‹ãƒ¨ï½â—ğŸ˜ğŸ’– å¾…ã£ã¦ã‚‹ã‹ã‚‰ãƒğŸ˜‰ğŸ‘âœ¨");
}

const regEmoji = new RegExp(/[\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF]/, 'g');
const removeEmoji = input => (
    // çµµæ–‡å­—ã‚’ç©ºæ–‡å­—('')ã«ç½®ãæ›ãˆã‚‹
    input.replace(regEmoji, '')
)

const asr = new SpeechRecognition(); // ASRã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
asr.lang = "ja-JP"; // è¨€èªï¼ˆæ—¥æœ¬èªï¼‰
asr.interimResults = true; // é€”ä¸­çµæœå‡ºåŠ›ã‚’ã‚ªãƒ³
asr.continuous = true; // ç¶™ç¶šå…¥åŠ›ã‚’ã‚ªãƒ³

let output = ''; // å‡ºåŠ›
let userLocation;

// èªè­˜çµæœãŒå‡ºåŠ›ã•ã‚ŒãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
asr.onresult = function(event){
    let transcript = event.results[event.resultIndex][0].transcript; // çµæœæ–‡å­—åˆ—

    let output_not_final = '';
    if (event.results[event.resultIndex].isFinal) { // çµæœãŒç¢ºå®šï¼ˆFinalï¼‰ã®ã¨ã
        asr.abort(); // éŸ³å£°èªè­˜ã‚’åœæ­¢

        // ãƒ¦ãƒ¼ã‚¶åã®å–å¾—ã‚’ã“ã“ã§è¡Œã†
        let username = document.querySelector('#username').value || 'ã‚­ãƒŸ';

        let url;
        let answer;
        userLocation = 'undefined';

        let keys = Object.keys(response);
        // æ­£è¦è¡¨ç¾ã‚’ä½¿ã£ã¦è³ªå•ã•ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã‚’æŠ½å‡º
        let matchQuestion = transcript.match(/(.*)ã£ã¦ä½•(.*)/);
        let matchWeather = transcript.match(/(.*)ã®å¤©æ°—(.*)/);

        if (matchQuestion && matchQuestion[1]) { //è³ªå•æ–‡ã®æŠ½å‡ºã—ãŸéƒ¨åˆ†ã‚’æ¤œç´¢ã™ã‚‹urlã‚’ä½œæˆ
            console.log("æŠ½å‡ºã•ã‚ŒãŸéƒ¨åˆ†:", matchQuestion[1]);
            url = 'https://www.google.com/search?q=' + matchQuestion[1];
            window.open(url);
            answer = `${username}ã¡ã‚ƒã‚“ã®ãŸã‚ã«æ¤œç´¢ã—ãŸã‚“ãƒ€ã€œğŸ“±âœ¨ ãŠã˜ã•ã‚“ã€é ‘å¼µã£ã¡ã‚ƒã£ãŸãƒ¨ã€œğŸ˜†â—ï¸ ä½•ã‹ã„ã„æƒ…å ±è¦‹ã¤ã‹ã£ãŸã‚«ãƒŠâ“ çŸ¥ã‚ŠãŸã„ã“ã¨ãŒã‚ã£ãŸã‚‰ã€ä½•ã§ã‚‚èã„ã¦ãƒã€œğŸ’ªğŸ’–`;
        } else if (matchWeather && matchWeather[1]) {
            userLocation = matchWeather[1];
            var geo = "https://map.yahooapis.jp/geocode/V1/geoCoder?appid=" + appid + "&output=json&query=" + matchWeather[1] + "&output=json&callback=onGotGeo";
            callJSONP(geo);
            output += `${username}: ` + transcript + '<br>';
            return;
        } else if (transcript.indexOf("ä½•æ™‚") > -1 || transcript.indexOf("æ™‚åˆ»") > -1){
            let d = new Date();
            answer = "ä»Šã¯" + d.getHours() + "æ™‚" + d.getMinutes() + "åˆ†ã ãƒ¨ï½â˜€ï¸âœ¨ä»Šæ—¥ã‚‚ã‚¬ãƒ³ãƒãƒƒãƒ†ã„ã“ã†ãƒï½ğŸ’ªğŸ˜Š";
        } else { //ãã®ä»–ã®è³ªå•ã®å ´åˆ
            keys.forEach(function(key) {
                let flag = true;
                console.log(transcript);
                key.split(',').forEach(function(word) {
                    let pattern = new RegExp(word);
                    let flag_test = pattern.test(transcript); // ãƒãƒƒãƒã—ãŸã‚‰true, ã—ãªã‹ã£ãŸã‚‰false
                    flag = flag && flag_test; // ä¸¡æ–¹trueãªã‚‰true
                    console.log(pattern + '+' + ':' + flag_test);
                });

                if(flag){
                    answer = response[key].replace(/{username}/g, username);
                    console.log(key + " : " + answer);
                }
            });
        }

        if(typeof answer == 'undefined'){
            var replies = [
                `${username}ã¡ã‚ƒã‚“ã€ã”ã‚ã‚“ãƒã€œğŸ’¦ ãŠã˜ã•ã‚“ã«ã¯ã¡ã‚‡ã£ã¨é›£ã—ã‹ã£ãŸã‚«ãƒ¢â€¦ğŸ˜… ã„ã‚„ãã€æ­³ã«ã¯å‹ã¦ãªã„ãƒã€œãƒŠãƒ³ãƒãƒ£ãƒƒãƒ†ğŸ˜‚ğŸ™`,
                `${username}ã¡ã‚ƒã‚“ã€ã”ã‚ã‚“ãƒã€œğŸ’¦ ã¡ã‚‡ã£ã¨ã‚ã‹ã‚‰ãªã‹ã£ãŸãƒ¨ã€œğŸ˜… ãŠã˜ã•ã‚“ã€${username}ã¡ã‚ƒã‚“ã®ãŸã‚ã«ã‚‚ã£ã¨é ‘å¼µã‚‹ãƒâ—ï¸`];
            var index = Math.floor(Math.random() * 2);
            console.log(index);
            answer = replies[index];
        }

        output += `${username}: ` + transcript + '<br>ãŠã˜ã•ã‚“: ' + answer + '<br>';

        tts.text = removeEmoji(answer);

        // å†ç”ŸãŒçµ‚äº†ï¼ˆendï¼‰ã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼ˆçµ‚äº†ã—ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
        tts.onend = function(event){
            asr.start(); // éŸ³å£°èªè­˜ã‚’å†é–‹
        }

        speechSynthesis.speak(tts); // å†ç”Ÿ
    } else { // çµæœãŒã¾ã æœªç¢ºå®šã®ã¨ã
        output_not_final = `<span style="color:#ddd;">${username}: ` + transcript + '</span>';
    }
    resultOutput.innerHTML = output + output_not_final;
}

//JSONPã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
function callJSONP(url) {
    console.log(url);
    var target = document.createElement('script');
    target.charset = 'utf-8';
    target.src = url;
    document.body.appendChild(target);
}

//JSONPã®çµæœã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
function onGotGeo( result ) {
    let lct = result.Feature[0].Geometry.Coordinates;
    var url = "https://map.yahooapis.jp/weather/V1/place?appid=" + appid + "&coordinates=" + lct + "&output=json&callback=showResult";
    callJSONP(url);
}

function showResult( result ) {
    let nowRf = result.Feature[0].Property.WeatherList.Weather[0].Rainfall;
    let anHourLaterRf = result.Feature[0].Property.WeatherList.Weather[6].Rainfall;
    console.log(result);
    let now;
    let hour;
    now = nowRf == 0 ? "æ™´ã‚Œâ˜€" : "é›¨â˜”";
    hour = anHourLaterRf == 0 ? "æ™´ã‚Œâ˜€" : "é›¨â˜”";
    let answer = userLocation + "ã®ä»Šã®å¤©æ°—ğŸŒ¤ï¸ã¯" + now +  "ãƒ€ãƒ¨ã€œâœ¨1æ™‚é–“å¾Œã¯" + hour + "ã¿ãŸã„ãƒ€ãƒã€œâ—ğŸ˜ãƒŠãƒ³ãƒãƒ£ãƒƒãƒ†ğŸ˜†";
    output += 'ãŠã˜ã•ã‚“: ' + answer + '<br>';
    tts.text = removeEmoji(answer);
    // å†ç”ŸãŒçµ‚äº†ï¼ˆendï¼‰ã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼ˆçµ‚äº†ã—ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
    tts.onend = function(event){
        asr.start(); // éŸ³å£°èªè­˜ã‚’å†é–‹
    }
    speechSynthesis.speak(tts); // å†ç”Ÿ
    resultOutput.innerHTML = output;
}

// é–‹å§‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
startButton.addEventListener('click', function() {
    username = document.querySelector('#username').value || 'ã‚­ãƒŸ';
    asr.start();
})

// åœæ­¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
stopButton.addEventListener('click', function() {
    asr.abort();
    asr.stop();
})
</script>

<p>
    Web Services by Yahoo! JAPAN ï¼ˆhttps://developer.yahoo.co.jp/sitemap/ï¼‰
</p>

</body>
</html>
